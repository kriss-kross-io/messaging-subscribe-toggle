<link rel="import" href="../polymer/polymer.html">

<!-- Paper elements -->
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">

<!-- Firebase elements -->
<link rel="import" href="../polymerfire/firebase-app.html">
<link rel="import" href="../polymerfire/firebase-document.html">
<link rel="import" href="../polymerfire/firebase-messaging.html">

<!--
`<messaging-subscribe-toggle>`

@demo demo/messaging-subscribe-toggle/index.html 
-->

<dom-module id="messaging-subscribe-toggle">

  <template>

    <style>
      :host {
        display: block;
      }
    </style>

    <firebase-app
        name="test-messaging-app"
        api-key="[[dbConfig.apiKey]]",
        auth-domain="[[dbConfig.authDomain]]",
        database-url="[[dbConfig.databaseURL]]",
        storage-bucket=[[dbConfig.storageBucket]]""
        messaging-sender-id="[[dbConfig.messageSenderId]]"></firebase-app>
    <firebase-messaging id="messaging"
        app-name="test-messaging-app"
        token="{{_token}}"
        last-message="{{lastMessage}}"
        on-message="_handleMessage"></firebase-messaging>
    <firebase-document id="topicDocument"
        app-name="test-messaging-app"
        path="/topics/[[topic]]/[[_token]]"
        data="{{_topicData}}"></firebase-document>

    <paper-toggle-button id="subscribe"
        on-tap="_toggleSubscription"
        checked="[[!isEmpty(_topicData)]]">[[value]]</paper-toggle-button>

  </template>

  <script>
    Polymer({

      is: 'messaging-subscribe-toggle',

      /**
       * Fired when messaging registration token for this session changes.
       * @event token-changed
       */

      /**
       * Fired when a notification is received.
       * @event message-received
       */

      properties: {
        dbConfig: {
          type: Object,
          value: function() {
            return {
              apiKey: null,
              authDomain: null,
              databaseURL: null,
              storageBucket: null,
              messageSenderId: '861178504130'
            }
          }
        },
        _token: {
          type: String,
          observer: '_tokenChanged'
        },
        lastMessage: {
          type: Object,
          readOnly: true,
          notify: true
        },
        topic: {
          type: String
        },
        _topicData: {
          type: Object
        },
        value: {
          type: String,
          value: ""
        }
      },

      _tokenChanged: function(token) {
        if (token) {
          this.fire('token-changed', { token: token });
        }
      },

      _handleMessage: function(message) {
        this.fire('message-received', { message: message })
      },

      _toggleSubscription: function() {
        if (this.$.subscribe.checked) {
          this.$.messaging.requestPermission().then(function() {
            // permission was granted
            if (!this._token) {
              this.addEventListener('token-changed', function(event) {
                // setting topic data
                this.set('_topicData', true);
              }.bind(this));
            } else {
              // setting topic data
              this.set('_topicData', true);
            }
          }.bind(this), function(err) {
            // permission was denied
          });
        } else {
          // resetting topic data
          this.set('_topicData', null);
        }
      },

      isEmpty: function(value) {
        return this.$.topicDocument.valueIsEmpty(value);
      }

    });
  </script>
</dom-module>
