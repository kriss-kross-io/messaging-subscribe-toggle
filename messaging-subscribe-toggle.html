<link rel="import" href="../polymer/polymer.html">

<!-- Paper elements -->
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">

<!-- Firebase elements -->
<link rel="import" href="../polymerfire/firebase-app.html">
<link rel="import" href="../polymerfire/firebase-document.html">
<link rel="import" href="../polymerfire/firebase-messaging.html">

<!--
`<messaging-subscribe-toggle>`

@demo demo/index.html 
-->

<dom-module id="messaging-subscribe-toggle">

  <template>

    <style>
      :host {
        display: block;
      }
    </style>

    <firebase-app
        name="test-messaging-app"
        api-key="AIzaSyCGWWkF6VyRA98_y-xDINbRxTocflavzOc",
        auth-domain="test-9cc76.firebaseapp.com",
        database-url="https://test-9cc76.firebaseio.com",
        storage-bucket="test-9cc76.appspot.com"
        messaging-sender-id="861178504130"></firebase-app>
    <firebase-messaging id="messaging"
        app-name="test-messaging-app"
        token="{{_token}}"
        last-message="{{lastMessage}}"
        on-message="_handleMessage"></firebase-messaging>
    <firebase-document id="topicDocument"
        app-name="test-messaging-app"
        path="/topics/[[_token]]"
        data="{{_topicData}}"></firebase-document>

    <paper-toggle-button id="subscribe"
        on-tap="_toggleSubscription"
        checked="[[_topicData.topic]]">[[value]]</paper-toggle-button>

  </template>

  <script>
    Polymer({

      is: 'messaging-subscribe-toggle',

      /**
       * Fired when messaging registration token for this session changes.
       * @event token-changed
       */

      /**
       * Fired when a notification is received.
       * @event message-received
       */

      properties: {
        _token: {
          type: String,
          observer: '_tokenChanged'
        },
        lastMessage: {
          type: Object,
          readOnly: true,
          notify: true
        },
        topic: {
          type: String
        },
        _topicData: {
          type: Object
        },
        value: {
          type: String,
          value: "Subscribe to notifications"
        }
      },

      _tokenChanged: function(token) {
        if (token) {
          this.fire('token-changed', { token: token });
        }
      },

      _handleMessage: function(message) {
        this.fire('message-received', { message: message })
      },

      _toggleSubscription: function() {
        if (this.$.subscribe.checked) {
          this.$.messaging.requestPermission().then(function() {
            // permission was granted
            if (!this._token) {
              this.addEventListener('token-changed', function(event) {
                // setting topic data
                this.set('_topicData', { topic: this.topic });
              });
            } else {
              // setting topic data
              this.set('_topicData', { topic: this.topic });
            }
          }.bind(this), function(err) {
            // permission was denied
          });
        } else {
          // resetting topic data
          this.set('topicData', null);
        }
      }

    });
  </script>
</dom-module>
