<link rel="import" href="../polymer/polymer.html">

<!-- Paper elements -->
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">

<!-- Firebase elements -->
<link rel="import" href="../polymerfire/firebase-document.html">
<link rel="import" href="../polymerfire/firebase-messaging.html">

<!--
`<messaging-subscribe-toggle>`

@demo demo/messaging-subscribe-toggle/index.html 
-->

<dom-module id="messaging-subscribe-toggle">

  <template>

    <style>
      :host {
        display: block;
      }
    </style>

    <firebase-messaging id="messaging"
        token="{{_token}}"></firebase-messaging>
    <firebase-document id="topicDocument"
        path="/topics/[[topic]]/[[_token]]"
        data="{{_topicData}}"></firebase-document>

    <paper-toggle-button id="subscribe"
        on-tap="_toggleSubscription"
        checked="[[!isEmpty(_topicData)]]">[[value]]</paper-toggle-button>

  </template>

  <script>
    Polymer({

      is: 'messaging-subscribe-toggle',

      /**
       * Fired when messaging registration token for this session changes.
       * @event token-changed
       */

      properties: {
        _token: {
          type: String,
          observer: '_tokenChanged'
        },
        topic: {
          type: String
        },
        _topicData: {
          type: Object
        },
        value: {
          type: String,
          value: ""
        }
      },

      _tokenChanged: function(token) {
        if (token) {
          this.fire('token-changed', { token: token });
        }
      },

      _toggleSubscription: function() {
        if (this.$.subscribe.checked) {
          this.$.messaging.requestPermission().then(function() {
            // permission was granted
            if (!this._token) {
              this.addEventListener('token-changed', function(event) {
                // setting topic data
                this.set('_topicData', true);
              }.bind(this));
            } else {
              // setting topic data
              this.set('_topicData', true);
            }
          }.bind(this), function(err) {
            // permission was denied
          });
        } else {
          // resetting topic data
          this.set('_topicData', null);
        }
      },

      isEmpty: function(value) {
        return this.$.topicDocument.valueIsEmpty(value);
      }

    });
  </script>
</dom-module>
